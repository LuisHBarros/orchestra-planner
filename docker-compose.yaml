services:
    db:
        image: postgres:16-alpine
        container_name: orchestra_db
        restart: always
        environment:
            POSTGRES_USER: ${DATABASE_USER:-postgres}
            POSTGRES_PASSWORD: ${DATABASE_PASSWORD:-postgres}
            POSTGRES_DB: ${DATABASE_NAME:-orchestra_planner}
        ports:
            - "5432:5432"
        volumes:
            - postgres_data:/var/lib/postgresql/data
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U postgres"]
            interval: 5s
            timeout: 5s
            retries: 5

    redis:
        image: redis:7-alpine
        container_name: orchestra_redis
        restart: always
        ports:
            - "6379:6379"
        healthcheck:
            test: ["CMD", "redis-cli", "ping"]
            interval: 5s
            timeout: 5s
            retries: 5

    backend:
        build:
            context: ./backend
            dockerfile: Dockerfile
        container_name: orchestra_api
        depends_on:
            db:
                condition: service_healthy
            redis:
                condition: service_healthy
            migrations:
                condition: service_completed_successfully
        environment:
            - DATABASE_URL=postgresql+asyncpg://${DATABASE_USER:-postgres}:${DATABASE_PASSWORD:-postgres}@db:5432/${DATABASE_NAME:-orchestra_planner}
            - REDIS_URL=redis://redis:6379/0
            - APP_ENV=local
            - LOG_LEVEL=info
            - RATE_LIMIT_PROVIDER=redis
        ports:
            - "8000:8000"
        command: uvicorn src.main:app --host 0.0.0.0 --port 8000

    # Serviço para garantir que o banco está migrado antes da API subir
    migrations:
        build: ./backend
        depends_on:
            db:
                condition: service_healthy
            redis:
                condition: service_healthy
        environment:
            - DATABASE_URL=postgresql+asyncpg://${DATABASE_USER:-postgres}:${DATABASE_PASSWORD:-postgres}@db:5432/${DATABASE_NAME:-orchestra_planner}
        command: alembic upgrade head
        restart: "no"

volumes:
    postgres_data:
